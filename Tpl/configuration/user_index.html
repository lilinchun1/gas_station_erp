<!doctype html>
<html lang="zh-CN">
<head>
	<meta charset="UTF-8">
	<title>职员维护</title>
	<!--<link rel="stylesheet" href="../../Public/css/configuration.css"/>-->
	<link rel="stylesheet" href="	__PUBLIC__/css/configuration.css"/>
	<script type="text/javascript" src="__PUBLIC__/js/jquery-1.10.2.min.js"></script>
</head>
<body>
<include file="./Tpl/include/pb-head.html" />

<div id="container">
	<div class="left">
		<include file="./Tpl/include/pb-configuration-aside.html" />
	</div>
	<div class="right">
		<div class="right-con">
			<div class="org-right-con">
				<div class="role-control" id="j-fixed-top">
					<div class="role-inquire">
						<form name="userSelect" method="get" action="{:U('configuration/User/show_user')}">
							<label for="user-name" class="">姓名</label>
							<input type="text" name="realname_txt" id="realname_txt" class="input-org-info"/>
							<label for="at-org" class="">所属组织机构</label>
							<input type="text" name="org_name_txt" id="org_name_txt" class="input-org-info"/>
							<label for="use-id" class="use-id">账号</label>
							<input type="text" name="username_txt" id="username_txt" class="input-org-info"/>
							<input type="submit" id="select_button" name="select_button" class="role-control-btn" value="查询"/>
						</form>
					</div>
					<div class="org-right-btns">
						<form action="">
							<button type="button" class="area-btn" id="j_add_button">添加</button>
							<button type="button" class="area-btn" id="j_mod_button">编辑</button>
							<button type="button" id="j_del_button" class="area-btn">删除</button>
							<button type="button" id="j_reset_password" class="area-btn">重置密码</button>
							<button type="button" id="j_modify_user_state" class="area-btn">激活/失效</button>
						</form>
					</div>
				</div>
				<div class="role-table over-h-y">
					<input type="text" id="selrole_hidden_id" style="display:none;" value="" /><!--ID缓存框-->
					<ul class="role-table-list">
						<li>
							<span class="span-1"></span>
							<span class="span-1"><b>姓名</b></span>
							<span class="span-1"><b>性别</b></span>
							<span class="span-1"><b>联系电话</b></span>
							<span class="span-3"><b>所属组织机构</b></span>
							<span class="span-2"><b>账号</b></span>
							<span class="span-1"><b>角色</b></span>
							<span class="span-1"><b>状态</b></span>
						</li>
						<volist name="list" id="vo">
							<li class="list_sel" onclick="selectUserRadio('{$vo['uid']}');">
								<span class="span-1">
									<input type="radio" name="radio1" id="{$vo['userRadioID']}" value="{$vo['uid']}"
										 class="role-table-radio"/>
								</span>
								<span class="span-1" title="#">{$vo.realname}</span>
								<span class="span-1" title="#">{$vo.sex}</span>
								<span class="span-1" title="#">{$vo.telphone}</span>
								<span class="span-3" title="#">{$vo.orgname}</span>
								<span class="span-2" title="#">{$vo.username}</span>
								<span class="span-1" title="#">{$vo.rolename}</span>
								<span class="span-1" title="#">{$vo.del_flag}</span>
								<span class="roleid_hidden" style="display:none;" title="#">{$vo.uid}</span>

							</li>
						</volist>
					</ul>
					<div class="resultpage">{$page}</div>
			</div>
				<div class="role-table over-h-y">
					<div class="data-log">
						<h3>操作日志</h3>
					</div>
					<ul class="role-table-list role-table-list2">
						<li>
							<span class="span-3"><b>操作人</b></span>
							<span class="span-3"><b>操作时间</b></span>
							<span class="span-3"><b>操作日志</b></span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
						<li>
							<span class="span-3" title="#">Lorem ipsum dolor sit amet.</span>
							<span class="span-3" title="#">Beatae fugiat impedit ipsa porro!</span>
							<span class="span-3" title="#">Atque corporis laudantium perspiciatis qui?</span>
						</li>
					</ul>
				</div>
			</div>
		</div>
	</div>
</div>
<include file="./Tpl/include/pb-foot.html" />
<div id="j_mod_edit" style="display:none;">
	<div class="alert-role-add">
		<h3>编辑职员信息</h3>
		<div class="alert-user-add-con">
			<form action="">
				<p>
					<label for="user-addname" class="role-lab">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</label>
					<input type="text" name="addname" id="mod-name" class="input-role-name"/>
					<input type="radio" name="change-sex" class="change-sex" id="mod-man" value="1"/><label for="man" class="sex">男</label>
					<input type="radio" name="change-sex" class="change-sex" id="mod-woman" value="0"/><label for="woman" class="sex">女</label>
				</p>
				<p>
					<label for="user-phone" class="role-lab">联系电话</label>
					<input type="text" name="addname" id="mod-user-phone" class="input-role-name"/>
				</p>
				<p>
					<label for="login-id" class="role-lab">登陆账号</label>
					<input type="text" name="addname" id="mod-login-id" class="input-role-name"/>
				</p>
				<p>
					<label for="login-id" class="email">邮&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;箱</label>
					<input type="text" name="addname" id="mod-email" class="input-role-name"/>
				</p>
				<div>
					<em>角色</em>
					<ul class="user-checkbox-list" id="j_mod_ul_checkbox">

					</ul>
				</div>
				<p>
					<button type="button" class="alert-btn2" id="j_mod_save">保存</button>
					<button type="button" class="alert-btn2" id="j_mod_close">关闭</button>
					<input type="text" id="user_id" value="" />
				</p>
			</form>
		</div>
	</div>
</div>

<div id="j_add_win" style="display:none;">
	<div class="alert-role-add">
		<h3>添加职员信息</h3>
		<div class="alert-user-add-con">
			<form action="">
				<p>
					<label for="user-addname" class="role-lab">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名</label>
					<input type="text" name="addname" id="user-addname" class="input-role-name"/><i class="red-color pdl10">*</i>
					<input type="radio" name="change-sex" class="change-sex" id="man" value="1"/><label for="man" class="sex">男</label>
					<input type="radio" name="change-sex" class="change-sex" id="woman" value="0"/><label for="woman" class="sex">女</label>
				</p>
				<p>
					<label for="user-phone" class="role-lab">联系电话</label>
					<input type="text" name="addname" id="user-phone" class="input-role-name"/>
				</p>
				<p>
					<label for="login-id" class="role-lab">登陆账号</label>
					<input type="text" name="addname" id="login-id" class="input-role-name"/><i class="red-color pdl10">*</i>
				</p>
				<p>
					<label for="login-id" class="email">邮&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;箱</label>
					<input type="text" name="addname" id="email" class="input-role-name"/>
				</p>
				<p>
					<label for="role_agent_id_add" class="role-lab">所属组织</label>
					<select id="role_agent_id_add" class="role_agent_id">
						<option value="">请选择组织</option>
					</select>
				</p>
				<div>
					<em>角色</em>
					<ul class="user-checkbox-list" id="j_ul_checkbox">

					</ul>
				</div>
				<p>
					<button type="button" class="alert-btn2" id="j_add_save">保存</button>
					<button type="button" class="alert-btn2" id="j_add_close">关闭</button>

				</p>
			</form>
		</div>
	</div>
</div>
<!--删除确认框-->
<div class="divout" id="j_del_win" style="display:none;">
	<div class="alert-role-add" >
		<h3>职员信息</h3>
		<div class="alert-role-add-con">
			<p class="delete-message">请确认是否删除？</p>
			<input type="hidden" value="" id="del_id_hidden"/>
			<p>
				<button type="button" class="alert-btn2" id="j_del_ok">确定</button>
				<a href="." class="closeDOMWindow">
					<button type="button" class="alert-btn2">取消</button>
				</a>
			</p>
		</div>
	</div>
</div>
<script type="text/javascript" src="__PUBLIC__/js/jquery-1.6.1.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.SuperSlide.2.1.1.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/jquery.DOMwindow.js" type="text/javascript"></script><!--模框JS插件-->
<link rel="stylesheet" href="__PUBLIC__/css/tree/tree.css" type="text/css">
<script type="text/javascript" src="__PUBLIC__/js/tree/jquery.ztree.core-3.5.js"></script>
<script type="text/javascript" src="__PUBLIC__/js/tree/jquery.ztree.excheck-3.5.js"></script>
<script>
$(function(){
	//给添加修改赋组织值
	var getAgentUrl = "{:U('configuration/Role/getAgentArr')}";
	$.post(getAgentUrl,{},function(data){
		$.each(data,function(i,n){
			var mstr = "";
			switch(n['lv']){
				case 1:mstr = "==";break;
				case 2:mstr = "====";break;
				case 3:mstr = "======";break;
				case 4:mstr = "========";break;
				case 5:mstr = "==========";break;
				case 6:mstr = "============";break;
			}
			$(".role_agent_id").append("<option value='"+n['agent_id']+"'>"+mstr+n['agent_name']+"</option>");
		})
	},"json");
	//组织改变触发
	$("#role_agent_id_add").change(function(){
		var role_agent_id = $(this).val();
		var getAgentUrl = "{:U('configuration/Role/getRoleByAgentId')}";
		$.post(getAgentUrl,{'role_agent_id':role_agent_id},function(data){
			$('#j_ul_checkbox li').remove();
			$.each(data,function(i,n){
				checked = "";
				if(roleStr.indexOf(n['roleid']+",") >= 0 )
				{
					checked = "checked"
				}
				$('#j_ul_checkbox').append("<li><input type='checkbox' name='role' class='j_checkbox' value='"+n['roleid']+"' onclick='j_checkbox(this)' "+checked+"/><label for='ck1' class='role-lab'>"+n['rolename']+"</label></li>");
			})
		},"json");
	});
	
});

//保持组织id用,分割
var roleStr = "";
//复选框触发
function j_checkbox(obj){
	if($(obj).attr("checked")){
		roleStr += $(obj).val()+",";
	}else{
		roleStr = roleStr.replace($(obj).val()+",","");
	}
}



/*
$array=explode("a","asddad addsadassd dasdadfsdfasdaaa",4);
//print_r($array);

//剔除字符串左边开头的空格,并返回
//如有第二个参数则是剔除左边开头的空格换成剔除第二个参数里的字符串
$str=ltrim("a asd ","a");

//剔除字符串右边开头的空格
$str=rtrim(" asd ");

 */



	var user_val='';
	function selectUserRadio(user_id){
		user_val = user_id;
	}

	$(document).ready(function () {
		//单击编辑
		$('#j_mod_button').click(function(){

			//单击保存按钮
			$('#j_mod_save').click(function(){
				var add_uid=$('#user_id').val();
				var add_login_id= $('#mod-login-id').val(); //登陆账号
				var add_user_addname = $('#mod-name').val();	  //姓名
				var add_telphone_txt = $('#mod-user-phone').val();	  //联系电话
				var add_user_email = $('#mod-email').val();	  //邮箱*/
				var add_user_sex = $(':radio[name="change-sex"]:checked').val(); //性别
				var add_org_id = $('#mod_id_hidden').val();  //所属组织机构
				var add_user_ckbox="";
				var emailRegExp = new RegExp(		 "[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?");
				if (!emailRegExp.test(add_user_email)||add_user_email.indexOf('.')==-1){
					alert("请检查邮箱格式");
					return false;
				}
				$(":checkbox[name=role]").each(function() {
					if ($(this).attr("checked")) {
						add_user_ckbox += $(this).attr('id')+",";
					}
				});

				var add_save_handleUrl="{:U('configuration/User/edit_user')}";
				$.getJSON(add_save_handleUrl,{
							"modify_userid_txt":add_uid,
							"modify_realname_txt":add_user_addname,
							"modify_telphone_txt":add_telphone_txt,
							"modify_email_txt":add_user_email,
							"modify_user_name_txt":add_login_id,
							"modify_sex_txt":add_user_sex,
							"modify_org_txt":add_org_id,
							"modify_role_txt":add_user_ckbox},
						function (data){
							alert(data);
							window.location.href = window.location.href;
						}
						,'json'
				)
			});
			$('#j_mod_ul_checkbox').html("");//清空
			//列出角色
			var handleUrl="{:U('configuration/Role/show_all_role')}";
			$.ajax({
				type: "POST",
				url: handleUrl,
				async: false,
				dataType: "json",
				success: function(data){
					$.each(data,function(key,val){
						var id=val['id'];
						var value=val['value'];
						$('#j_mod_ul_checkbox').append("<li><input type='checkbox' name='role' class='j_checkbox' value='"+value+"'  id='"+id+"'/><label for='ck1' class='role-lab'>"+value+"</label></li>");
					});
				},

				error: function(XMLHttpRequest, textStatus, errorThrown) {
					// alert("请求失败!");
				}
			});
			//显示
			if( user_val == ''){
				alert("请选择一条职员信息再进行编辑");
				return;
			}
			//给编辑框赋值
			var mod_handleUrl="{:U('configuration/User/userDetailSelect')}";
			var arr=new Array();
			var str=new String();
			var user_id_val=$("#selrole_hidden_id").val();
			$.getJSON(mod_handleUrl,{ "user_id":user_id_val},
					function (data){
					   //alert(data['username']);
						$("#user_id").val(data['uid']);//uid
						$("#mod-name").val(data['realname']);
						$("#mod-user-phone").val(data['telphone']);
						$("#mod-login-id").val(data['username']);
						$("#mod-email").val(data['email']);
						$("#mod_citySel").val(data['orgname']);
						$("#mod_id_hidden").val(data['orgid']);
						

						str=data['rolename'];
						arr=str.split(',');
						for(var i=0;i<arr.length;i++)
						{
							var val=value=arr[i];
							$("[value="+val+"]").attr("checked",true);
							//$(".j_checkbox").val(arr[i]).attr("checked",true);
							//alert();
						}


						var sex = data['sex'];
						if(sex == '0'){
							$('#mod-woman').eq(0).attr("checked",true);
						}else{
							$('#mod-man').eq(0).attr("checked",true);
						}
					}
					,'json'
			);
			$("#j_mod_close").click(function(){
				window.location.href = window.location.href;
			});

			//弹出窗口
			$.openDOMWindow({
				loader:1,
				loaderHeight:16,
				loaderWidth:17,
				windowSourceID:'#j_mod_edit'
			});
			return false;
		});
		//单击添加按钮
		$('#j_add_button').click(function(){
			/*
			//列出角色
			var handleUrl="{:U('configuration/Role/show_all_role')}";
			$.ajax({
				type: "POST",
				url: handleUrl,
				async: false,
				dataType: "json",
				success: function(data){
					$.each(data,function(key,val){
						var id=val['id'];
						var value=val['value'];
					   // $("#j_ul").append("<li><input type='checkbox' id='"+id+"'/>"+value+"</li><br>");
						$('#j_ul_checkbox').append("<li><input type='checkbox' name='role' value='"+value+"'  id='"+id+"'/><label for='ck1' class='role-lab'>"+value+"</label></li>");
					});
				},

				error: function(XMLHttpRequest, textStatus, errorThrown) {
					// alert("请求失败!");
				}
			});
			*/
			//单击保存按钮
			$('#j_add_save').click(function(){
				var add_login_id= $('#user-addname').val(); //登陆账号
				if (add_login_id=="")
				{	
					alert("请输入真实姓名");
					return false;
				}
				var add_user_addname = $('#login-id').val();	  //姓名
				if (add_user_addname=="")
				{	
					alert("请输入登入账号");
					return false;
				}
				var add_telphone_txt = $('#user-phone').val();	  //联系电话
				var add_user_email = $('#email').val();	  //邮箱*/
				var add_user_sex = $(':radio[name="change-sex"]:checked').val(); //性别
				var add_org_id = $('#id_hidden').val();  //所属组织机构
				if (add_org_id=="")
				{	
					alert("请选择组织结构");
					return false;
				}
				var add_user_ckbox="";
				$(":checkbox[name=role]").each(function() {
					if ($(this).attr("checked")) {
						add_user_ckbox += $(this).attr('id')+",";
					}
				});
				if (add_user_ckbox=="")
				{	
					alert("请选择角色");
					return false;
				}

				var emailRegExp = new RegExp(		 "[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?");
				if (!emailRegExp.test(add_user_email)||add_user_email.indexOf('.')==-1){
					alert("请检查邮箱格式");
					return false;
				}
				var add_save_handleUrl="{:U('configuration/User/add_user')}";
				$.getJSON(add_save_handleUrl,{
							"add_user_name_txt":add_user_addname,
							"add_telphone_txt":add_telphone_txt,
							"add_email_txt":add_user_email,
							"add_realname_txt":add_login_id,
							"add_sex_txt":add_user_sex,
							"add_org_txt":add_org_id,
							"add_role_txt":add_user_ckbox},
							function (data){
								var tmp_msg = "{:C('add_user_success')}";
								if(tmp_msg == data)
								{
									alert(data);
									window.location.href = window.location.href;
								}
								else
								{
									alert(data);
								}
							}
							,'json'
					)
			});
			$("#j_add_close").click(function(){
				window.location.href = window.location.href;
			});
			//弹出窗口
			$.openDOMWindow({
				loader:1,
				loaderHeight:16,
				loaderWidth:17,
				windowSourceID:'#j_add_win'
			});
			return false;
		});

			$('#j_del_button').click(function(){
			 if( user_val == ''){
				alert("请选择一条职员信息再进行编辑");
				return;
			 }
			 $.openDOMWindow({
				loader:1,
				loaderHeight:16,
				loaderWidth:17,
				windowSourceID:'#j_del_win'
			 });
			 return false;
		});

		//单击删除确认按钮
		$('#j_del_ok').click(function(){
			var delete_user_id_txt= $("#selrole_hidden_id").val();;
			var del_handleUrl="{:U('configuration/User/delete_user')}";
			$.getJSON(del_handleUrl,{"delete_user_id_txt":delete_user_id_txt},
					function (data){
						alert(data);
						window.location.href = window.location.href;
					}
					,'json'
			);
		});

		//重置密码
		$('#j_reset_password').click(function(){
			if( user_val == ''){
				alert("请选择一条职员信息再进行编辑");
				return;
			}
			var reset_userid_txt= $("#selrole_hidden_id").val();
			var del_handleUrl="{:U('configuration/User/reset_password')}";
			$.getJSON(del_handleUrl,{"reset_userid_txt":reset_userid_txt},
					function (data){
						alert(data);
						window.location.href = window.location.href;
					}
					,'json'
			);
		});

		//激活失效
		$('#j_modify_user_state').click(function(){
			if( user_val == ''){
				alert("请选择一条职员信息再进行编辑");
				return;
			}
			var modify_userid_txt= $("#selrole_hidden_id").val();
			var del_handleUrl="{:U('configuration/User/modify_user_state')}";
			$.getJSON(del_handleUrl,{"modify_userid_txt":modify_userid_txt},
					function (data){
						alert(data);
						window.location.href = window.location.href;
					}
					,'json'
			);
		});


//===============================================单击查询框里某一条数据=======================================
	$(".list_sel").click(function(){
		$(this).find(".role-table-radio").attr("checked",'checked'); 
		var id= $(this).find(".roleid_hidden").text();
		$("#selrole_hidden_id").val(id);
	});
});
</script>
</body>
</html>